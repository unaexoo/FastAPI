# 1ì¥ ê°œë°œ ì¤€ë¹„

[íŒŒì¼ëª…: projects/myapi/main.py]

```python
from fastapi import FastAPI

app = FastAPI()

@app.get("/hello")
def hello():
    return {"message": "ì•ˆë…•í•˜ì„¸ìš” íŒŒì´ë³´"}

```

- `@app.get("/hello")`Â ì–´ë…¸í…Œì´ì…˜ì€Â `/hello`Â ë¼ëŠ” URLìš”ì²­ì´ ë°œìƒí•˜ë©´ í•´ë‹¹ í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ì—¬ ê²°ê³¼ë¥¼ ë¦¬í„´í•˜ë¼ëŠ” ì˜ë¯¸
- `/hello`Â ë¼ëŠ” URLì´ ìš”ì²­ë˜ë©´ FastAPIëŠ”Â `{"message": "ì•ˆë…•í•˜ì„¸ìš” íŒŒì´ë³´"}`Â ë¼ëŠ” ë”•ì…”ë„ˆë¦¬ë¥¼ ë¦¬í„´

# docs

- í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•œ API ë¬¸ì„œ
- ì½ê¸° ë¬¸ì„œë§Œ ë³´ê³  ì‹¶ë‹¤ë©´  `/redoc`

```python
http://127.0.0.1:8000/docs
```

# FastAPI ì„œë²„ì™€ í†µì‹ 

- SvelteëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ì— ì„ ì–¸ëœ ë³€ìˆ˜ì˜ ê°’ì„ HTML íƒœê·¸ì— ì¤‘ê´„í˜¸ ê¸°í˜¸ë¥¼ ì‚¬ìš©í•˜ì—¬ í‘œì‹œí•  ìˆ˜ ìˆë‹¤.

```html
<script>
  let message;

  fetch("http://127.0.0.1:8000/hello").then((response) => {
    response.json().then((json) => {
      message = json.message;
    });
  });
</script>

<h1>{message}</h1>
```

# 2ì¥ ê°œë°œ ê¸°ì´ˆ ê³µì‚¬

# í”„ë¡œì íŠ¸ êµ¬ì¡°

```html
â”œâ”€â”€ main.py
â”œâ”€â”€ database.py
â”œâ”€â”€ models.py
â”œâ”€â”€ domain
â”‚   â”œâ”€â”€ answer
â”‚   â”œâ”€â”€ question
â”‚   â””â”€â”€ user
â””â”€â”€ frontend
```

- [main.py](http://main.py) : FastAPI í”„ë¡œì íŠ¸ì˜ ì „ì²´ì ì¸ í™˜ê²½ì„ ì„¤ì •í•˜ëŠ” íŒŒì¼
- [database.py](http://database.py) : ë°ì´í„°ë² ì´ìŠ¤ì™€ ê´€ë ¨ëœ ì„¤ì •
- [models.py](http://models.py) : ëª¨ë¸ í´ë˜ìŠ¤ë“¤ì„ ì •ì˜í•  models.py íŒŒì¼ì´ í•„ìš”. ORM. SQLAlchemy

**API domain ë””ë ‰í„°ë¦¬**

- ì§ˆë¬¸ (question)
    - ë¼ìš°í„° íŒŒì¼ - URLê³¼ APIì˜ ì „ì²´ì ì¸ ë™ì‘ì„ ê´€ë¦¬
- ë‹µë³€ (answer)
    - ë°ì´í„°ë² ì´ìŠ¤ ì²˜ë¦¬ íŒŒì¼ - ë°ì´í„°ì˜ ìƒì„±(**C**reate), ì¡°íšŒ(**R**ead), ìˆ˜ì •(**U**pdate), ì‚­ì œ(**D**elete)ë¥¼ ì²˜ë¦¬ (CRUD)
- ì‚¬ìš©ì (user)
    - ì…ì¶œë ¥ ê´€ë¦¬ íŒŒì¼ - ì…ë ¥ ë°ì´í„°ì™€ ì¶œë ¥ ë°ì´í„°ì˜ ìŠ¤í™ ì •ì˜ ë° ê²€ì¦

```html
question_router.py - ë¼ìš°í„° íŒŒì¼
question_crud.py - ë°ì´í„°ë² ì´ìŠ¤ ì²˜ë¦¬ íŒŒì¼
question_schema.py - ì…ì¶œë ¥ ê´€ë¦¬ íŒŒì¼
```

**frontend**

- `frontend/dist`Â ë””ë ‰í„°ë¦¬ì— ìƒì„±ëœ ë¹Œë“œ íŒŒì¼ë“¤ì„ ë°°í¬ì‹œì— ì‚¬ìš©

---

# ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‰½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ORM

```sql
insert into question (subject, content) values ('ì•ˆë…•í•˜ì„¸ìš”', 'ê°€ì… ì¸ì‚¬ë“œë¦½ë‹ˆë‹¤ ^^');
insert into question (subject, content) values ('ì§ˆë¬¸ ìˆìŠµë‹ˆë‹¤', 'ORMì´ ê¶ê¸ˆí•©ë‹ˆë‹¤');
```

```python
question1 = Question(subject=â€™ì•ˆë…•í•˜ì„¸ìš”â€™, content='ê°€ì… ì¸ì‚¬ë“œë¦½ë‹ˆë‹¤ ^^')
db.add(question1)
question2 = Question(subject=â€™ì§ˆë¬¸ ìˆìŠµë‹ˆë‹¤â€™, content='ORMì´ ê¶ê¸ˆí•©ë‹ˆë‹¤')
db.add(question2)
```

**SQLAlchemy ORM ë¼ì´ë¸ŒëŸ¬ë¦¬ ì‚¬ìš©í•˜ê¸°**

- `SeesionLocal` : ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ì†í•˜ê¸° ìœ„í•´ í•„ìš”í•œ í´ë˜ìŠ¤
- create_engine, sessionmaker ë“±ì„ ì‚¬ìš©í•˜ëŠ”ê²ƒì€ SQLAlchemy ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ë”°ë¼ì•¼ í•  ê·œì¹™
- `autocommit=False` : ë°ì´í„°ë¥¼ ë³€ê²½í–ˆì„ ë•Œ commitì´ë¼ëŠ” ì‚¬ì¸ì„ ì£¼ì–´ì•¼ë§Œ ì‹¤ì œ ì €ì¥ì´ ë¨
    - ë°ì´í„°ë¥¼ ì˜ëª» ì €ì¥í•œ ê²½ìš° rollback ì‚¬ì¸ìœ¼ë¡œ ë˜ëŒë¦¬ëŠ” ê²ƒì´ ê°€ëŠ¥
- `autocommit=True` : commit ì‚¬ì¸ì´ ì—†ì–´ë„ ì¦‰ì‹œ ë°ì´í„°ë² ì´ìŠ¤ì— ë³€ê²½ì‚¬í•­ì´ ì ìš©
    - rollbackë„ ë™ì‘í•˜ì§€ ì•ŠëŠ”ë‹¤
- `create_engine` : ì»¨ë„¥ì…˜ í’€ì„ ìƒì„±
    - ì»¨ë„¥ì…˜ í’€ :  ë°ì´í„°ë² ì´ìŠ¤ì— ì ‘ì†í•˜ëŠ” ê°ì²´ë¥¼ ì¼ì • ê°¯ìˆ˜ë§Œí¼ ë§Œë“¤ì–´ ë†“ê³  ëŒë ¤ê°€ë©° ì‚¬ìš©í•˜ëŠ” ê²ƒ(ë°ì´í„° ë² ì´ìŠ¤ì— ì ‘ì†í•˜ëŠ” ì„¸ì…˜ìˆ˜ë¥¼ ì œì–´í•˜ê³ , ë˜ ì„¸ì…˜ ì ‘ì†ì— ì†Œìš”ë˜ëŠ” ì‹œê°„ì„ ì¤„ì´ê³ ì í•˜ëŠ” ìš©ë„ë¡œ ì‚¬ìš©)

```python
from sqlalchemy import create_engine
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy.orm import sessionmaker

SQLALCHEMY_DATABASE_URL = "sqlite:///./myapi.db" # ë°ì´í„°ë² ì´ìŠ¤ ì ‘ì† ì£¼ì†Œ

engine = create_engine(
    SQLALCHEMY_DATABASE_URL, connect_args={"check_same_thread":False}
)
SessionLocal = sessionmaker(autocommit=False,autoflush=False,bind=engine)

Base = declarative_base()

```

**ì§ˆë¬¸ ëª¨ë¸ ìƒì„±í•˜ê¸°**

- Questionê³¼ ê°™ì€ ëª¨ë¸ í´ë˜ìŠ¤ëŠ” ì•ì„œ database.pyì—ì„œ ì •ì˜í•œÂ `Base`Â í´ë˜ìŠ¤ë¥¼ ìƒì†í•˜ì—¬ ë§Œë“¤ì–´ì•¼ í•¨
- `__tablename__`ì€ ëª¨ë¸ì— ì˜í•´ ê´€ë¦¬ë˜ëŠ” í…Œì´ë¸”ì˜ ì´ë¦„
- Question ëª¨ë¸ì€ ê³ ìœ  ë²ˆí˜¸(id), ì œëª©(subject), ë‚´ìš©(content), ì‘ì„±ì¼ì‹œ(create_date) ì†ì„±ìœ¼ë¡œ êµ¬ì„± â†’ Columnìœ¼ë¡œ ìƒì„±

```python
from sqlalchemy import Column, Integer, String, Text, DateTime
from database import Base

class Question(Base):
    __tablename__ = "question"

    id = Column(Integer, primary_key=True)
    subject = Column(String, nullable=False)
    content = Column(Text,nullable=False)
    create_date = Column(DateTime, nullable=False)
```

**ë‹µë³€ ëª¨ë¸ ìƒì„±í•˜ê¸°**

- `relationship`
    - ì²« ë²ˆì§¸ íŒŒë¼ë¯¸í„° : ì°¸ì¡°í•  ëª¨ë¸ëª…
    - ë‘ ë²ˆì§¸ backref íŒŒë¼ë¯¸í„° : ì—­ì°¸ì¡° ì„¤ì •
        - ì—­ì°¸ì¡° : ì§ˆë¬¸ì—ì„œ ë‹µë³€ì„ ê±°ê¾¸ë¡œ ì°¸ì¡°í•˜ëŠ” ê²ƒ

```python
from sqlalchemy import Column, Integer, String, Text, DateTime, ForeignKey
from sqlalchemy.orm import relationship

from database import Base

class Question(Base):
    __tablename__ = "question"

    id = Column(Integer, primary_key=True)
    subject = Column(String, nullable=False)
    content = Column(Text, nullable=False)
    create_date = Column(DateTime, nullable=False)

class Answer(Base):
    __tablename__ = "answer"

    id = Column(Integer, primary_key=True)
    content = Column(Text, nullable=False)
    create_date = Column(DateTime, nullable=False)
    question_id = Column(Integer, ForeignKey("question.id"))
    question = relationship("Question", backref="answers")
```

**ëª¨ë¸ì„ ì´ìš©í•´ í…Œì´ë¸” ìë™ìœ¼ë¡œ ìƒì„±í•˜ê¸°**

- SQLAlchemyì˜ alembicì„ ì´ìš©í•´ ë°ì´í„°ë² ì´ìŠ¤ í…Œì´ë¸”ì„ ìƒì„±
- alembicì€ SQLAlchemyë¡œ ì‘ì„±í•œ ëª¨ë¸ì„ ê¸°ë°˜ìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì‰½ê²Œ ê´€ë¦¬í•  ìˆ˜ ìˆê²Œ ë„ì™€ì£¼ëŠ” ë„êµ¬ì´ë‹¤. ì˜ˆë¥¼ë“¤ì–´ [models.py](http://models.py/) íŒŒì¼ì— ì‘ì„±í•œ ëª¨ë¸ì„ ì´ìš©í•˜ì—¬ í…Œì´ë¸”ì„ ìƒì„±í•˜ê³  ë³€ê²½í• ìˆ˜ ìˆë‹¤.

```python
(myapi) c:/projects/myapi> pip install alembic
```

```python
(myapi) c:/projects/myapi> alembic init migrations
```

[íŒŒì¼ëª…: projects/myapi/alembic.ini]

```python
(... ìƒëµ ...)
sqlalchemy.url = sqlite:///./myapi.db
(... ìƒëµ ...)
```

[íŒŒì¼ëª…: projects/myapi/migrations/env.py]

```python
(... ìƒëµ ...)
import models
(... ìƒëµ ...)
# add your model's MetaData object here
# for 'autogenerate' support
# from myapp import mymodel
# target_metadata = mymodel.Base.metadata
target_metadata = models.Base.metadata
(... ìƒëµ ...)

```

ë¦¬ë¹„ì „ íŒŒì¼ ìƒì„±í•˜ê¸°

- ë¦¬ë¹„ì „(revision)ì´ë€ ìƒì„±ëœÂ `fed28bf52b05_.py`Â íŒŒì¼ì—ì„œÂ `.py`Â í™•ì¥ìë¥¼ ì œì™¸í•œÂ `fed28bf52b05_`ì™€ ê°™ì€ ë²„ì „ ë²ˆí˜¸
- ëª…ë ¹ì„ ìˆ˜í–‰í•  ë•Œ ë¬´ì‘ìœ„ë¡œ ë§Œë“¤ì–´ì§

```python
(myapi) c:/projects/myapi> alembic revision --autogenerate
```

- ë¦¬ë¹„ì „ íŒŒì¼ì„Â `alembic upgrade head`Â ëª…ë ¹ìœ¼ë¡œ ì‹¤í–‰

```python
(myapi) c:/projects/myapi> alembic upgrade head
```

â†’ ì´ëŸ¬ê³  ë‚˜ë©´ myapi ë‚´ì— myapi.db  íŒŒì¼ì´ ìƒì„±ë¨

<aside>
ğŸ’¡

ì°¸ê³ (alembic ì—†ì´ í…Œì´ë¸” ìƒì„±)

main.pyì—ì„œ ì‹¤í–‰ì‹œ í•„ìš”í•œ í…Œì´ë¸”ë“¤ì´ ëª¨ë‘ ìƒì„±

- ë§¤ìš° ê°„ë‹¨í•œ ë°©ë²•ì´ì§€ë§Œ ë°ì´í„°ë² ì´ìŠ¤ì— í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•Šì„ ê²½ìš°ì—ë§Œ í…Œì´ë¸”ì„ ìƒì„±
- í•œë²ˆ ìƒì„±ëœ í…Œì´ë¸”ì— ëŒ€í•œ ë³€ê²½ ê´€ë¦¬ë¥¼ í•  ìˆ˜ëŠ” ì—†ë‹¤. ì´ëŸ¬í•œ ì´ìœ ë¡œ ì´ ì±…ì—ì„œëŠ” ì´ ë°©ë²•ì„ ì‚¬ìš©í•˜ì§€ ì•Šê³  alembicì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ê´€ë¦¬í•  ê²ƒ

```python
import models
from database import engine
models.Base.metadata.create_all(bind=engine)
```

</aside>

ë¼ìš°í„° ë§Œë“¤ê¸°

 [íŒŒì¼ëª…: projects/myapi/domain/question/question_router.py]

- ë¼ìš°í„° íŒŒì¼ì— ë°˜ë“œì‹œ í•„ìš”í•œ ê²ƒì€ APIRouter í´ë˜ìŠ¤ë¡œ ìƒì„±í•œ router ê°ì²´
- router ê°ì²´ë¥¼ ìƒì„±í•˜ì—¬ FastAPI ì•±ì— ë“±ë¡í•´ì•¼ë§Œ ë¼ìš°íŒ… ê¸°ëŠ¥ì´ ë™ì‘
- ë¼ìš°íŒ…ì´ë€ FastAPIê°€ ìš”ì²­ë°›ì€ URLì„ í•´ì„í•˜ì—¬ ê·¸ì— ë§ëŠ” í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ì—¬ ê·¸ ê²°ê³¼ë¥¼ ë¦¬í„´í•˜ëŠ” í–‰ìœ„
- router ê°ì²´ ìƒì„±ì‹œ ì‚¬ìš©í•œ prefix ì†ì„±ì€ ìš”ì²­ URLì— í•­ìƒ í¬í•¨ë˜ì–´ì•¼ í•˜ëŠ” ê°’
- `/api/question/list`Â ë¼ëŠ” URL ìš”ì²­ì´ ë°œìƒí•˜ë©´Â `/api/question`Â ì´ë¼ëŠ” prefixê°€ ë“±ë¡ëœ question_router.py íŒŒì¼ì˜Â `/list`ë¡œ ë“±ë¡ëœ í•¨ìˆ˜ question_listê°€ ì‹¤í–‰ë˜ëŠ” ê²ƒ

```python
from fastapi import APIRouter

from database import SessionLocal
from models import Question

router = APIRouter(
    prefix="/api/question",
)

@router.get("/list")
def question_list():
    db = SessionLocal()
    _question_list = db.query(Question).order_by(Question.create_date.desc()).all()
    db.close()
    return _question_list
```

ë°ì´í„°ë² ì´ìŠ¤ ì„¸ì…˜ì˜ ìƒì„±ê³¼ ë°˜í™˜ ìë™í™”

db ì„¸ì…˜ ê°ì²´ë¥¼ ìƒì„±í•œ í›„ì—Â `db.close()`ë¥¼ ìˆ˜í–‰í•˜ì§€ ì•Šìœ¼ë©´ SQLAlchemyê°€ ì‚¬ìš©í•˜ëŠ” ì»¨ë„¥ì…˜ í’€ì— db ì„¸ì…˜ì´ ë°˜í™˜ë˜ì§€ ì•Šì•„ ë¬¸ì œê°€ ìƒê¸´ë‹¤.

Pydantic

[íŒŒì¼ëª…: projects/myapi/domain/question/question_router.py]

- question_list í•¨ìˆ˜ì˜ ë¦¬í„´ê°’ì€ Question ìŠ¤í‚¤ë§ˆë¡œ êµ¬ì„±ëœ ë¦¬ìŠ¤íŠ¸ì„ì„ ì˜ë¯¸í•œë‹¤.

```python
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from database import get_db
from domain.question import question_schema
from models import Question

router = APIRouter(
    prefix="/api/question",
)

@router.get("/list", response_model=list[question_schema.Question])
def question_list(db: Session = Depends(get_db)):
    _question_list = db.query(Question).order_by(Question.create_date.desc()).all()
    return _question_list

```

crud

[íŒŒì¼ëª…: projects/myapi/domain/question/question_crud.py]

```python
from models import Question
from sqlalchemy.orm import Session

def get_question_list(db: Session):
    question_list = db.query(Question)\
        .order_by(Question.create_date.desc())\
        .all()
    return question_list
```

[íŒŒì¼ëª…: projects/myapi/domain/question/question_router.py]

```python
from fastapi import APIRouter, Depends
from sqlalchemy.orm import Session

from database import get_db
from domain.question import question_schema, question_crud
from models import Question

router = APIRouter(
    prefix="/api/question",
)

@router.get("/list", response_model=list[question_schema.Question])
def question_list(db: Session = Depends(get_db)):
    _question_list = question_crud.get_question_list(db)
    return _question_list
```

### ì§ˆë¬¸ ëª©ë¡ í™”ë©´ êµ¬í˜„

[íŒŒì¼ëª…: projects/myapi/frontend/src/App.svelte]

- get_question_list() í•¨ìˆ˜ëŠ” ì•ì—ì„œ ì‘ì„±í–ˆë˜ ì§ˆë¬¸ ëª©ë¡ API(`/api/question/list`)ë¥¼ í˜¸ì¶œí•˜ëŠ” í•¨ìˆ˜
- í˜¸ì¶œí•˜ì—¬ ì–»ì€ question_listëŠ” Svelteì˜ eachë¬¸ì„ ìˆœíšŒí•˜ë©° ì œëª©ì„ í‘œì‹œ

```html
<script>
  let question_list = []

  function get_question_list() {
    fetch("http://127.0.0.1:8000/api/question/list").then((response) => {
      response.json().then((json) => {
        question_list = json
      })
    })
  }

  get_question_list()
</script>

<ul>
  {#each question_list as question}
    <li>{question.subject}</li>
  {/each}
</ul>

```
